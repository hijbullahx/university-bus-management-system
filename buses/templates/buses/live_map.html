{% extends 'base.html' %}
{% block title %}Live Bus Map - Bus Tracking{% endblock %}
{% block extra_css %}
<style>
    #fullMap { height: calc(100vh - 120px); width: 100%; }
    .bus-popup { min-width: 200px; }
    .driver-popup { min-width: 180px; }
    .legend { background: white; padding: 10px; border-radius: 5px; box-shadow: 0 2px 5px rgba(0,0,0,0.2); }
    .legend-item { display: flex; align-items: center; margin-bottom: 5px; }
    .legend-icon { width: 20px; height: 20px; border-radius: 50%; margin-right: 8px; display: flex; align-items: center; justify-content: center; }
</style>
{% endblock %}
{% block content %}
<div class="container-fluid p-0">
    <div class="bg-dark text-white py-2 px-4 d-flex justify-content-between align-items-center">
        <h5 class="mb-0"><i class="bi bi-geo-alt me-2"></i>Live Tracking</h5>
        <div>
            <span class="badge bg-primary me-2"><span id="activeBuses">0</span> Buses</span>
            <span class="badge bg-success me-2"><span id="activeDrivers">0</span> Drivers</span>
            <span class="text-muted small">Auto-refresh: 5s</span>
        </div>
    </div>
    <div id="fullMap"></div>
</div>
{% endblock %}

{% block extra_js %}
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    const map = L.map('fullMap').setView([40.7128, -74.0060], 13);
    
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: 'Â© OpenStreetMap contributors'
    }).addTo(map);

    // Bus icon (blue)
    const busIcon = L.divIcon({
        html: '<div style="background: #007bff; border-radius: 50%; width: 36px; height: 36px; display: flex; align-items: center; justify-content: center; border: 3px solid white; box-shadow: 0 2px 5px rgba(0,0,0,0.3);"><i class="bi bi-bus-front-fill text-white"></i></div>',
        className: '',
        iconSize: [36, 36],
        iconAnchor: [18, 18],
        popupAnchor: [0, -18]
    });

    // Driver icon (green)
    const driverIcon = L.divIcon({
        html: '<div style="background: #198754; border-radius: 50%; width: 32px; height: 32px; display: flex; align-items: center; justify-content: center; border: 3px solid white; box-shadow: 0 2px 5px rgba(0,0,0,0.3);"><i class="fas fa-user text-white" style="font-size: 14px;"></i></div>',
        className: '',
        iconSize: [32, 32],
        iconAnchor: [16, 16],
        popupAnchor: [0, -16]
    });

    let busMarkers = {};
    let driverMarkers = {};

    // Add legend
    const legend = L.control({position: 'bottomright'});
    legend.onAdd = function(map) {
        const div = L.DomUtil.create('div', 'legend');
        div.innerHTML = `
            <strong style="display: block; margin-bottom: 8px;">Legend</strong>
            <div class="legend-item">
                <div class="legend-icon" style="background: #007bff;"><i class="bi bi-bus-front-fill text-white" style="font-size: 10px;"></i></div>
                <span>Bus</span>
            </div>
            <div class="legend-item">
                <div class="legend-icon" style="background: #198754;"><i class="fas fa-user text-white" style="font-size: 10px;"></i></div>
                <span>Driver</span>
            </div>
        `;
        return div;
    };
    legend.addTo(map);

    function updateBuses() {
        fetch('/api/buses/locations/')
            .then(response => response.json())
            .then(data => {
                document.getElementById('activeBuses').textContent = data.length;
                
                data.forEach(bus => {
                    const popupContent = `
                        <div class="bus-popup">
                            <h6 class="mb-2"><i class="bi bi-bus-front me-2"></i>${bus.bus_number}</h6>
                            <p class="mb-1"><strong>Route:</strong> ${bus.route_name}</p>
                            <p class="mb-1"><strong>ETA:</strong> ${bus.eta}</p>
                            <p class="mb-2"><strong>Speed:</strong> ${bus.speed || 'N/A'} km/h</p>
                            <a href="/buses/${bus.id}/follow/" class="btn btn-sm btn-primary w-100">
                                <i class="bi bi-geo me-1"></i>Follow Bus
                            </a>
                        </div>
                    `;
                    
                    if (busMarkers[bus.id]) {
                        busMarkers[bus.id].setLatLng([bus.latitude, bus.longitude]);
                        busMarkers[bus.id].setPopupContent(popupContent);
                    } else {
                        busMarkers[bus.id] = L.marker([bus.latitude, bus.longitude], {icon: busIcon})
                            .addTo(map)
                            .bindPopup(popupContent);
                    }
                });
            })
            .catch(err => console.log('Bus error:', err));
    }

    function updateDrivers() {
        fetch('/api/location/active/')
            .then(response => response.json())
            .then(data => {
                document.getElementById('activeDrivers').textContent = data.length;
                
                // Track current driver IDs
                const currentDriverIds = new Set(data.map(d => d.driver_id));
                
                // Remove markers for drivers no longer active
                Object.keys(driverMarkers).forEach(id => {
                    if (!currentDriverIds.has(parseInt(id))) {
                        map.removeLayer(driverMarkers[id]);
                        delete driverMarkers[id];
                    }
                });
                
                data.forEach(driver => {
                    const lastUpdate = new Date(driver.last_updated).toLocaleTimeString();
                    const popupContent = `
                        <div class="driver-popup">
                            <h6 class="mb-2"><i class="fas fa-user me-2"></i>${driver.driver_name || driver.driver_username}</h6>
                            <p class="mb-1"><strong>Route:</strong> ${driver.route_name || 'Not assigned'}</p>
                            <p class="mb-0"><strong>Last update:</strong> ${lastUpdate}</p>
                        </div>
                    `;
                    
                    if (driverMarkers[driver.driver_id]) {
                        driverMarkers[driver.driver_id].setLatLng([driver.latitude, driver.longitude]);
                        driverMarkers[driver.driver_id].setPopupContent(popupContent);
                    } else {
                        driverMarkers[driver.driver_id] = L.marker([driver.latitude, driver.longitude], {icon: driverIcon})
                            .addTo(map)
                            .bindPopup(popupContent);
                    }
                });

                // Fit bounds to all markers
                fitMapBounds();
            })
            .catch(err => console.log('Driver error:', err));
    }

    function fitMapBounds() {
        const allMarkers = [...Object.values(busMarkers), ...Object.values(driverMarkers)];
        if (allMarkers.length > 0) {
            const group = new L.featureGroup(allMarkers);
            map.fitBounds(group.getBounds().pad(0.1));
        }
    }

    // Initial load
    updateBuses();
    updateDrivers();
    
    // Auto-refresh
    setInterval(updateBuses, 5000);
    setInterval(updateDrivers, 5000);
});
</script>
{% endblock %}
