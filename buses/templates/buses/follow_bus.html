{% extends 'base.html' %}
{% block title %}Follow {{ bus.bus_number }} - Bus Tracking{% endblock %}
{% block extra_css %}
<style>
    #followMap { height: calc(100vh - 200px); width: 100%; }
    .info-panel { position: absolute; top: 10px; right: 10px; z-index: 1000; }
</style>
{% endblock %}
{% block content %}
<div class="container-fluid py-3">
    <div class="row mb-3">
        <div class="col-12 d-flex justify-content-between align-items-center">
            <div>
                <a href="{% url 'buses:bus_list' %}" class="btn btn-outline-secondary btn-sm me-2">
                    <i class="bi bi-arrow-left"></i> Back
                </a>
                <span class="h4 mb-0"><i class="bi bi-geo-alt-fill text-danger me-2"></i>Following: {{ bus.bus_number }}</span>
            </div>
            <div>
                <span class="badge bg-success fs-6" id="busStatus">Tracking...</span>
            </div>
        </div>
    </div>
    
    <div class="row">
        <div class="col-md-9">
            <div class="card shadow-sm">
                <div class="card-body p-0 position-relative">
                    <div id="followMap"></div>
                    <div class="info-panel">
                        <div class="card shadow" style="width: 250px;">
                            <div class="card-body">
                                <h6 class="card-title">{{ bus.bus_number }}</h6>
                                <p class="mb-1"><strong>Route:</strong> <span id="routeName">{{ bus.current_route.name|default:"N/A" }}</span></p>
                                <p class="mb-1"><strong>Speed:</strong> <span id="busSpeed">-</span> km/h</p>
                                <p class="mb-0"><strong>Last Update:</strong> <span id="lastUpdate">-</span></p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card shadow-sm">
                <div class="card-header bg-primary text-white">
                    <i class="bi bi-clock me-2"></i>ETA to Stops
                </div>
                <div class="card-body p-0" style="max-height: 400px; overflow-y: auto;">
                    <ul class="list-group list-group-flush" id="etaList">
                        <li class="list-group-item text-center text-muted">Loading...</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    const busId = {{ bus.id }};
    const map = L.map('followMap').setView([40.7128, -74.0060], 15);
    
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

    const busIcon = L.divIcon({
        html: '<div style="background: #dc3545; border-radius: 50%; width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; border: 3px solid white; box-shadow: 0 2px 8px rgba(0,0,0,0.4);"><i class="bi bi-bus-front-fill text-white" style="font-size: 18px;"></i></div>',
        className: '',
        iconSize: [40, 40],
        iconAnchor: [20, 20]
    });

    let busMarker = null;
    let pathLine = null;
    let pathCoords = [];

    function updateBusLocation() {
        fetch(`/api/buses/${busId}/`)
            .then(r => r.json())
            .then(data => {
                if (data.latest_location) {
                    const lat = parseFloat(data.latest_location.latitude);
                    const lng = parseFloat(data.latest_location.longitude);
                    
                    if (busMarker) {
                        busMarker.setLatLng([lat, lng]);
                    } else {
                        busMarker = L.marker([lat, lng], {icon: busIcon}).addTo(map);
                        map.setView([lat, lng], 16);
                    }

                    pathCoords.push([lat, lng]);
                    if (pathLine) {
                        pathLine.setLatLngs(pathCoords);
                    } else {
                        pathLine = L.polyline(pathCoords, {color: '#007bff', weight: 4}).addTo(map);
                    }

                    document.getElementById('busSpeed').textContent = data.latest_location.speed || '-';
                    document.getElementById('lastUpdate').textContent = new Date().toLocaleTimeString();
                    document.getElementById('busStatus').textContent = 'Active';
                    
                    map.panTo([lat, lng]);
                }
            })
            .catch(err => {
                document.getElementById('busStatus').textContent = 'Connection Lost';
                document.getElementById('busStatus').className = 'badge bg-danger fs-6';
            });
    }

    updateBusLocation();
    setInterval(updateBusLocation, 3000);
});
</script>
{% endblock %}
