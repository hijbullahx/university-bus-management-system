{% extends 'base.html' %}
{% block title %}Dashboard - Bus Tracking{% endblock %}
{% block content %}
<div class="container-fluid py-4">
    <div class="row mb-4">
        <div class="col-12">
            <h2><i class="bi bi-speedometer2 me-2"></i>Welcome, {{ user.get_full_name|default:user.username }}!</h2>
            <p class="text-muted">Track buses in real-time and view schedules</p>
            <div class="btn-group" role="group">
                <a href="{% url 'accounts:user_home' %}" class="btn btn-outline-primary">
                    <i class="fas fa-home me-1"></i> User Home
                </a>
                <a href="{% url 'accounts:user_live_map' %}" class="btn btn-outline-success">
                    <i class="fas fa-map-marked-alt me-1"></i> Live Map
                </a>
                <a href="{% url 'schedules:user_schedules' %}" class="btn btn-outline-info">
                    <i class="fas fa-clock me-1"></i> Schedules
                </a>
            </div>
        </div>
    </div>
    
    <div class="row mb-4">
        <div class="col-md-8">
            <div class="card shadow-sm h-100">
                <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                    <span><i class="bi bi-geo-alt me-2"></i>Live Bus Map</span>
                    <a href="{% url 'buses:live_map' %}" class="btn btn-light btn-sm">
                        <i class="bi bi-arrows-fullscreen"></i> Full Screen
                    </a>
                </div>
                <div class="card-body p-0">
                    <div id="map" style="height: 400px; width: 100%;"></div>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card shadow-sm h-100">
                <div class="card-header bg-info text-white">
                    <i class="bi bi-bell me-2"></i>Notifications
                </div>
                <div class="card-body" style="max-height: 400px; overflow-y: auto;">
                    {% if notifications %}
                        {% for notification in notifications %}
                            <div class="alert alert-{{ notification.priority }} py-2 mb-2">
                                <strong>{{ notification.title }}</strong>
                                <p class="mb-0 small">{{ notification.message|truncatechars:80 }}</p>
                                <small class="text-muted">{{ notification.created_at|timesince }} ago</small>
                            </div>
                        {% endfor %}
                    {% else %}
                        <p class="text-muted text-center">No notifications</p>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <div class="col-md-6">
            <div class="card shadow-sm">
                <div class="card-header bg-success text-white">
                    <i class="bi bi-bus-front me-2"></i>Active Buses
                </div>
                <div class="card-body">
                    {% if buses %}
                        <div class="list-group list-group-flush">
                            {% for bus in buses %}
                                <a href="{% url 'buses:bus_detail' bus.id %}" class="list-group-item list-group-item-action d-flex justify-content-between align-items-center">
                                    <div>
                                        <strong>{{ bus.bus_number }}</strong>
                                        <span class="badge bg-primary ms-2">{{ bus.current_route.name|default:"No Route" }}</span>
                                    </div>
                                    <span class="badge bg-success">Active</span>
                                </a>
                            {% endfor %}
                        </div>
                        <a href="{% url 'buses:bus_list' %}" class="btn btn-outline-success mt-3 w-100">View All Buses</a>
                    {% else %}
                        <p class="text-muted text-center">No active buses</p>
                    {% endif %}
                </div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="card shadow-sm">
                <div class="card-header bg-warning text-dark">
                    <i class="bi bi-signpost-2 me-2"></i>Routes
                </div>
                <div class="card-body">
                    {% if routes %}
                        <div class="list-group list-group-flush">
                            {% for route in routes %}
                                <a href="{% url 'schedules:route_detail' route.id %}" class="list-group-item list-group-item-action">
                                    <strong>{{ route.name }}</strong>
                                    <p class="mb-0 small text-muted">{{ route.description|truncatechars:50 }}</p>
                                </a>
                            {% endfor %}
                        </div>
                        <a href="{% url 'schedules:route_list' %}" class="btn btn-outline-warning mt-3 w-100">View All Routes</a>
                    {% else %}
                        <p class="text-muted text-center">No routes available</p>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    const map = L.map('map').setView([40.7128, -74.0060], 13);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: 'Â© OpenStreetMap contributors'
    }).addTo(map);

    const busIcon = L.divIcon({
        html: '<i class="bi bi-bus-front-fill text-primary" style="font-size: 24px;"></i>',
        className: 'bus-marker',
        iconSize: [30, 30],
        iconAnchor: [15, 15]
    });

    let busMarkers = {};

    function updateBusLocations() {
        fetch('/api/buses/locations/')
            .then(response => response.json())
            .then(data => {
                data.forEach(bus => {
                    if (busMarkers[bus.id]) {
                        busMarkers[bus.id].setLatLng([bus.latitude, bus.longitude]);
                    } else {
                        busMarkers[bus.id] = L.marker([bus.latitude, bus.longitude], {icon: busIcon})
                            .addTo(map)
                            .bindPopup(`<strong>${bus.bus_number}</strong><br>Route: ${bus.route_name}<br>ETA: ${bus.eta}`);
                    }
                });
            })
            .catch(err => console.log('Error fetching bus locations'));
    }

    updateBusLocations();
    setInterval(updateBusLocations, 5000);
});
</script>
{% endblock %}
