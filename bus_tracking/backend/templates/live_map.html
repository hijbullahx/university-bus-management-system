{% extends 'base.html' %}
{% block title %}Live Map - Bus Tracking{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<style>
    #liveMap {
        height: calc(100vh - 200px);
        min-height: 500px;
        border-radius: 10px;
    }
    .bus-marker {
        background: #ffc107;
        border: 3px solid #fff;
        border-radius: 50%;
        width: 40px;
        height: 40px;
        display: flex;
        align-items: center;
        justify-content: center;
        box-shadow: 0 2px 10px rgba(0,0,0,0.3);
    }
    .bus-marker i {
        color: #333;
        font-size: 18px;
    }
    .bus-popup {
        min-width: 200px;
    }
    .bus-popup h6 {
        border-bottom: 2px solid #ffc107;
        padding-bottom: 5px;
        margin-bottom: 10px;
    }
    .location-permission-banner {
        position: absolute;
        top: 10px;
        left: 50%;
        transform: translateX(-50%);
        z-index: 1000;
        background: rgba(255,255,255,0.95);
        padding: 10px 20px;
        border-radius: 8px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.2);
    }
    .legend {
        background: white;
        padding: 10px;
        border-radius: 5px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.2);
    }
    .legend-item {
        display: flex;
        align-items: center;
        margin-bottom: 5px;
    }
    .legend-color {
        width: 20px;
        height: 20px;
        border-radius: 50%;
        margin-right: 8px;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <div class="row mb-3">
        <div class="col-12 d-flex justify-content-between align-items-center">
            <div>
                <h2><i class="fas fa-map-marked-alt me-2"></i>Live Bus Tracking</h2>
                <p class="text-muted mb-0">
                    <span id="activeBusCount">0</span> buses currently active
                    <span class="ms-3" id="lastUpdateTime"></span>
                </p>
            </div>
            <div>
                <button class="btn btn-outline-primary me-2" onclick="centerOnMyLocation()">
                    <i class="fas fa-crosshairs me-1"></i> My Location
                </button>
                <button class="btn btn-primary" onclick="refreshLocations()">
                    <i class="fas fa-sync-alt me-1"></i> Refresh
                </button>
            </div>
        </div>
    </div>

    <div class="row">
        <div class="col-lg-9">
            <div class="card shadow">
                <div class="card-body p-0 position-relative">
                    <div id="locationPermissionBanner" class="location-permission-banner d-none">
                        <i class="fas fa-location-arrow me-2 text-primary"></i>
                        <span id="permissionMessage">Allow location access for better experience</span>
                        <button class="btn btn-sm btn-primary ms-3" onclick="requestLocationPermission()">Allow</button>
                    </div>
                    <div id="liveMap"></div>
                </div>
            </div>
        </div>
        <div class="col-lg-3">
            <!-- Active Buses List -->
            <div class="card shadow mb-3">
                <div class="card-header bg-success text-white">
                    <i class="fas fa-bus me-2"></i>Active Buses
                </div>
                <div class="card-body p-0" style="max-height: 400px; overflow-y: auto;">
                    <div id="activeBusList" class="list-group list-group-flush">
                        <div class="list-group-item text-center text-muted py-4">
                            <i class="fas fa-spinner fa-spin me-2"></i>Loading...
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Legend -->
            <div class="card shadow">
                <div class="card-header">
                    <i class="fas fa-info-circle me-2"></i>Legend
                </div>
                <div class="card-body">
                    <div class="legend-item">
                        <div class="legend-color bg-success"></div>
                        <span>Active Bus (Moving)</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color bg-warning"></div>
                        <span>Bus at Stop</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color bg-primary"></div>
                        <span>Your Location</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
const csrfToken = '{{ csrf_token }}';
let map;
let busMarkers = {};
let userMarker = null;
let userLocationAllowed = false;
const defaultCenter = [23.8103, 90.4125]; // Dhaka, Bangladesh

// Initialize map
document.addEventListener('DOMContentLoaded', function() {
    initMap();
    checkLocationPermission();
    refreshLocations();
    
    // Auto-refresh every 10 seconds
    setInterval(refreshLocations, 10000);
});

function initMap() {
    map = L.map('liveMap').setView(defaultCenter, 13);
    
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: 'Â© OpenStreetMap contributors'
    }).addTo(map);
}

function checkLocationPermission() {
    if (!navigator.geolocation) {
        console.log('Geolocation not supported');
        return;
    }
    
    navigator.permissions.query({ name: 'geolocation' }).then(function(result) {
        if (result.state === 'granted') {
            userLocationAllowed = true;
            getUserLocation();
        } else if (result.state === 'prompt') {
            document.getElementById('locationPermissionBanner').classList.remove('d-none');
        }
    }).catch(function() {
        // Fallback for browsers that don't support permissions API
        document.getElementById('locationPermissionBanner').classList.remove('d-none');
    });
}

function requestLocationPermission() {
    navigator.geolocation.getCurrentPosition(
        function(position) {
            userLocationAllowed = true;
            document.getElementById('locationPermissionBanner').classList.add('d-none');
            updateUserLocation(position.coords.latitude, position.coords.longitude);
        },
        function(error) {
            document.getElementById('permissionMessage').textContent = 'Location access denied. Map will still work.';
            setTimeout(() => {
                document.getElementById('locationPermissionBanner').classList.add('d-none');
            }, 3000);
        }
    );
}

function getUserLocation() {
    if (navigator.geolocation && userLocationAllowed) {
        navigator.geolocation.getCurrentPosition(
            function(position) {
                updateUserLocation(position.coords.latitude, position.coords.longitude);
            },
            function(error) {
                console.log('Error getting location:', error);
            }
        );
    }
}

function updateUserLocation(lat, lng) {
    if (userMarker) {
        userMarker.setLatLng([lat, lng]);
    } else {
        const userIcon = L.divIcon({
            html: '<div style="background:#007bff;border:3px solid #fff;border-radius:50%;width:20px;height:20px;"></div>',
            className: '',
            iconSize: [20, 20],
            iconAnchor: [10, 10]
        });
        userMarker = L.marker([lat, lng], { icon: userIcon }).addTo(map);
        userMarker.bindPopup('<strong>Your Location</strong>');
    }
}

function centerOnMyLocation() {
    if (!userLocationAllowed) {
        requestLocationPermission();
        return;
    }
    
    navigator.geolocation.getCurrentPosition(
        function(position) {
            map.setView([position.coords.latitude, position.coords.longitude], 15);
            updateUserLocation(position.coords.latitude, position.coords.longitude);
        },
        function(error) {
            alert('Unable to get your location');
        }
    );
}

async function refreshLocations() {
    try {
        const response = await fetch('/api/locations/location/active/', {
            headers: { 'X-CSRFToken': csrfToken }
        });
        const data = await response.json();
        
        updateBusMarkers(data);
        updateBusList(data);
        updateStats(data);
        
    } catch (error) {
        console.error('Error fetching locations:', error);
    }
}

function updateBusMarkers(locations) {
    // Remove old markers that are no longer active
    Object.keys(busMarkers).forEach(id => {
        if (!locations.find(loc => loc.driver_id == id)) {
            map.removeLayer(busMarkers[id]);
            delete busMarkers[id];
        }
    });
    
    // Update or add markers
    locations.forEach(loc => {
        const busIcon = L.divIcon({
            html: `<div class="bus-marker"><i class="fas fa-bus"></i></div>`,
            className: '',
            iconSize: [40, 40],
            iconAnchor: [20, 20]
        });
        
        const popupContent = `
            <div class="bus-popup">
                <h6><i class="fas fa-bus me-2"></i>${loc.bus_number || 'Unknown'}</h6>
                <p class="mb-1"><strong>Route:</strong> ${loc.route_name || 'N/A'}</p>
                <p class="mb-1"><strong>Driver:</strong> ${loc.driver_name}</p>
                <p class="mb-1"><strong>Speed:</strong> ${loc.speed ? Math.round(loc.speed * 3.6) + ' km/h' : 'N/A'}</p>
                <p class="mb-0 text-muted small">Updated: ${new Date(loc.last_updated).toLocaleTimeString()}</p>
                <button class="btn btn-sm btn-primary mt-2 w-100" onclick="followBus(${loc.driver_id})">
                    <i class="fas fa-location-arrow me-1"></i> Follow Bus
                </button>
            </div>
        `;
        
        if (busMarkers[loc.driver_id]) {
            busMarkers[loc.driver_id].setLatLng([loc.latitude, loc.longitude]);
            busMarkers[loc.driver_id].setPopupContent(popupContent);
        } else {
            busMarkers[loc.driver_id] = L.marker([loc.latitude, loc.longitude], { icon: busIcon })
                .addTo(map)
                .bindPopup(popupContent);
        }
    });
}

function updateBusList(locations) {
    const listEl = document.getElementById('activeBusList');
    
    if (locations.length === 0) {
        listEl.innerHTML = `
            <div class="list-group-item text-center text-muted py-4">
                <i class="fas fa-bus-alt fa-2x mb-2 d-block"></i>
                No active buses at the moment
            </div>
        `;
        return;
    }
    
    listEl.innerHTML = locations.map(loc => `
        <a href="#" class="list-group-item list-group-item-action" onclick="focusOnBus(${loc.driver_id}, ${loc.latitude}, ${loc.longitude})">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <strong class="text-primary">${loc.bus_number || 'Bus'}</strong>
                    <small class="d-block text-muted">${loc.route_name || 'Route N/A'}</small>
                </div>
                <span class="badge bg-success">
                    <i class="fas fa-circle me-1" style="font-size: 8px;"></i>Live
                </span>
            </div>
            <small class="text-muted">${loc.driver_name}</small>
        </a>
    `).join('');
}

function updateStats(locations) {
    document.getElementById('activeBusCount').textContent = locations.length;
    document.getElementById('lastUpdateTime').textContent = 'Last updated: ' + new Date().toLocaleTimeString();
}

function focusOnBus(driverId, lat, lng) {
    map.setView([lat, lng], 16);
    if (busMarkers[driverId]) {
        busMarkers[driverId].openPopup();
    }
}

let followingBusId = null;
function followBus(driverId) {
    followingBusId = driverId;
    alert('Following bus. The map will auto-center on this bus.');
}
</script>
{% endblock %}
