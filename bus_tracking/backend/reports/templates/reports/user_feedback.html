{% extends 'base.html' %}

{% block title %}User Feedback - Reports{% endblock %}

{% block content %}
<div class="container mt-4">
    <nav aria-label="breadcrumb">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="{% url 'reports:report_list' %}">Reports</a></li>
            <li class="breadcrumb-item active">User Feedback</li>
        </ol>
    </nav>

    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2><i class="fas fa-comments me-2"></i>User Feedback Summary</h2>
        <button class="btn btn-outline-primary" onclick="exportToPDF()">
            <i class="fas fa-file-pdf me-1"></i>Export PDF
        </button>
    </div>

    <div class="row mb-4">
        <div class="col-md-4">
            <div class="card text-center bg-info text-white">
                <div class="card-body">
                    <h2>{{ avg_rating }}/5</h2>
                    <p class="mb-0">Average Rating</p>
                    <div class="mt-2">
                        {% for i in "12345" %}
                            {% if forloop.counter <= avg_rating %}
                                <i class="fas fa-star"></i>
                            {% else %}
                                <i class="far fa-star"></i>
                            {% endif %}
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-8">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">Ratings by Category</h5>
                </div>
                <div class="card-body">
                    <canvas id="categoryChart" height="120"></canvas>
                </div>
            </div>
        </div>
    </div>

    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">Category Summary</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        {% for cat in category_summary %}
                        <div class="col-md-4 mb-3">
                            <div class="d-flex justify-content-between align-items-center p-3 bg-light rounded">
                                <div>
                                    <strong>{{ cat.category|title }}</strong>
                                    <span class="badge bg-secondary ms-2">{{ cat.count }}</span>
                                </div>
                                <div>
                                    <span class="text-warning">
                                        {% for i in "12345" %}
                                            {% if forloop.counter <= cat.avg_rating %}
                                                <i class="fas fa-star"></i>
                                            {% else %}
                                                <i class="far fa-star"></i>
                                            {% endif %}
                                        {% endfor %}
                                    </span>
                                    <span class="ms-1">({{ cat.avg_rating|floatformat:1 }})</span>
                                </div>
                            </div>
                        </div>
                        {% empty %}
                        <div class="col-12 text-center text-muted">No feedback data available</div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="card">
        <div class="card-header">
            <h5 class="mb-0">Recent Feedback</h5>
        </div>
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-hover" id="feedbackTable">
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>User</th>
                            <th>Category</th>
                            <th>Rating</th>
                            <th>Route/Bus</th>
                            <th>Comment</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for feedback in feedbacks %}
                        <tr>
                            <td>{{ feedback.created_at|date:"M d, Y" }}</td>
                            <td>{% if feedback.is_anonymous %}Anonymous{% else %}{{ feedback.user.username }}{% endif %}</td>
                            <td>{{ feedback.get_category_display }}</td>
                            <td>
                                <span class="text-warning">
                                    {% for i in "12345" %}
                                        {% if forloop.counter <= feedback.rating %}
                                            <i class="fas fa-star"></i>
                                        {% else %}
                                            <i class="far fa-star"></i>
                                        {% endif %}
                                    {% endfor %}
                                </span>
                            </td>
                            <td>
                                {{ feedback.route.name|default:"" }}
                                {{ feedback.bus.bus_number|default:"" }}
                            </td>
                            <td>{{ feedback.comment|truncatewords:10 }}</td>
                            <td>
                                {% if feedback.is_resolved %}
                                    <span class="badge bg-success">Resolved</span>
                                {% else %}
                                    <span class="badge bg-warning">Pending</span>
                                {% endif %}
                            </td>
                        </tr>
                        {% empty %}
                        <tr>
                            <td colspan="7" class="text-center text-muted">No feedback found</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
<script>
const categoryData = [
    {% for cat in category_summary %}
    { category: "{{ cat.category|title }}", count: {{ cat.count }}, rating: {{ cat.avg_rating|floatformat:1 }} },
    {% endfor %}
];

const feedbackTableData = [
    {% for feedback in feedbacks %}
    {
        date: "{{ feedback.created_at|date:'Y-m-d' }}",
        user: "{% if feedback.is_anonymous %}Anonymous{% else %}{{ feedback.user.username }}{% endif %}",
        category: "{{ feedback.get_category_display }}",
        rating: {{ feedback.rating }},
        routeBus: "{{ feedback.route.name|default:'' }} {{ feedback.bus.bus_number|default:'' }}",
        comment: "{{ feedback.comment|truncatewords:15|escapejs }}"
    },
    {% endfor %}
];

if (categoryData.length > 0) {
    const ctx = document.getElementById('categoryChart').getContext('2d');
    new Chart(ctx, {
        type: 'bar',
        data: {
            labels: categoryData.map(c => c.category),
            datasets: [
                {
                    label: 'Count',
                    data: categoryData.map(c => c.count),
                    backgroundColor: '#0dcaf0',
                    yAxisID: 'y'
                },
                {
                    label: 'Avg Rating',
                    data: categoryData.map(c => c.rating),
                    type: 'line',
                    borderColor: '#ffc107',
                    backgroundColor: '#ffc107',
                    yAxisID: 'y1'
                }
            ]
        },
        options: {
            responsive: true,
            scales: {
                y: { beginAtZero: true, position: 'left' },
                y1: { beginAtZero: true, max: 5, position: 'right', grid: { drawOnChartArea: false } }
            }
        }
    });
}

function exportToPDF() {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();
    
    doc.setFontSize(18);
    doc.text('User Feedback Summary', 14, 22);
    doc.setFontSize(11);
    doc.text(`Average Rating: {{ avg_rating }}/5`, 14, 32);
    
    doc.autoTable({
        head: [['Date', 'User', 'Category', 'Rating', 'Route/Bus']],
        body: feedbackTableData.map(r => [r.date, r.user, r.category, r.rating + '/5', r.routeBus]),
        startY: 40,
        theme: 'grid'
    });
    
    doc.save('user_feedback_report.pdf');
}
</script>
{% endblock %}
