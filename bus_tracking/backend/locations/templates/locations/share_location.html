{% extends 'base.html' %}

{% block title %}Share Location - Driver{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="row justify-content-center">
        <div class="col-lg-8">
            <div class="card">
                <div class="card-header bg-primary text-white">
                    <h4 class="mb-0"><i class="fas fa-map-marker-alt me-2"></i>Live Location Sharing</h4>
                </div>
                <div class="card-body">
                    <!-- Status Display -->
                    <div class="text-center mb-4">
                        <div id="statusIndicator" class="mb-3">
                            <i class="fas fa-circle text-secondary fa-3x"></i>
                        </div>
                        <h5 id="statusText" class="text-muted">Location Sharing Inactive</h5>
                        <p id="lastUpdateText" class="text-muted small"></p>
                    </div>

                    <!-- Location Info -->
                    <div id="locationInfo" class="alert alert-info d-none">
                        <div class="row text-center">
                            <div class="col-6">
                                <strong>Latitude</strong>
                                <p id="latValue" class="mb-0">--</p>
                            </div>
                            <div class="col-6">
                                <strong>Longitude</strong>
                                <p id="lngValue" class="mb-0">--</p>
                            </div>
                        </div>
                        <hr>
                        <div class="row text-center">
                            <div class="col-4">
                                <strong>Accuracy</strong>
                                <p id="accuracyValue" class="mb-0">--</p>
                            </div>
                            <div class="col-4">
                                <strong>Speed</strong>
                                <p id="speedValue" class="mb-0">--</p>
                            </div>
                            <div class="col-4">
                                <strong>Updates</strong>
                                <p id="updateCount" class="mb-0">0</p>
                            </div>
                        </div>
                    </div>

                    <!-- Error Display -->
                    <div id="errorDisplay" class="alert alert-danger d-none">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        <span id="errorText"></span>
                    </div>

                    <!-- Permission Request -->
                    <div id="permissionPrompt" class="alert alert-warning d-none">
                        <i class="fas fa-info-circle me-2"></i>
                        Please allow location access when prompted by your browser.
                    </div>

                    <!-- Control Buttons -->
                    <div class="d-grid gap-2">
                        <button id="startBtn" class="btn btn-success btn-lg" onclick="startSharing()">
                            <i class="fas fa-play me-2"></i>Start Location Sharing
                        </button>
                        <button id="stopBtn" class="btn btn-danger btn-lg d-none" onclick="stopSharing()">
                            <i class="fas fa-stop me-2"></i>Stop Location Sharing
                        </button>
                    </div>

                    <!-- Mini Map -->
                    <div id="miniMapContainer" class="mt-4 d-none">
                        <h6><i class="fas fa-map me-2"></i>Your Location</h6>
                        <div id="miniMap" style="height: 250px; border-radius: 8px;"></div>
                    </div>
                </div>
                <div class="card-footer text-muted">
                    <small>
                        <i class="fas fa-shield-alt me-1"></i>
                        Your location is only shared while this page is open and sharing is active.
                    </small>
                </div>
            </div>

            <!-- Instructions -->
            <div class="card mt-3">
                <div class="card-header">
                    <h5 class="mb-0"><i class="fas fa-info-circle me-2"></i>How It Works</h5>
                </div>
                <div class="card-body">
                    <ul class="mb-0">
                        <li>Click "Start Location Sharing" to begin broadcasting your location</li>
                        <li>Your location updates every 5 seconds automatically</li>
                        <li>Users and admins can see your live location on the map</li>
                        <li>Location sharing stops when you close this page or click "Stop"</li>
                        <li>Keep this page open while driving for continuous updates</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
const UPDATE_INTERVAL = 5000; // 5 seconds
let watchId = null;
let updateInterval = null;
let updateCount = 0;
let miniMap = null;
let driverMarker = null;
let currentPosition = null;

// Get CSRF token
function getCSRFToken() {
    return document.querySelector('[name=csrfmiddlewaretoken]')?.value || 
           document.cookie.split('; ').find(row => row.startsWith('csrftoken='))?.split('=')[1] || '';
}

// Check initial status
document.addEventListener('DOMContentLoaded', function() {
    checkStatus();
});

function checkStatus() {
    fetch('/api/location/status/')
        .then(response => response.json())
        .then(data => {
            if (data.is_sharing && data.is_active) {
                // Resume sharing
                startSharing();
            }
        })
        .catch(err => console.log('Status check failed:', err));
}

function startSharing() {
    if (!navigator.geolocation) {
        showError('Geolocation is not supported by your browser');
        return;
    }

    document.getElementById('permissionPrompt').classList.remove('d-none');
    
    // Request location permission
    navigator.geolocation.getCurrentPosition(
        (position) => {
            // Permission granted
            document.getElementById('permissionPrompt').classList.add('d-none');
            beginLocationWatch();
            notifyServerStart();
        },
        (error) => {
            document.getElementById('permissionPrompt').classList.add('d-none');
            handleLocationError(error);
        },
        { enableHighAccuracy: true, timeout: 10000 }
    );
}

function beginLocationWatch() {
    // Update UI
    document.getElementById('startBtn').classList.add('d-none');
    document.getElementById('stopBtn').classList.remove('d-none');
    document.getElementById('locationInfo').classList.remove('d-none');
    document.getElementById('miniMapContainer').classList.remove('d-none');
    document.getElementById('errorDisplay').classList.add('d-none');
    
    updateStatus(true);
    initMiniMap();

    // Watch position
    watchId = navigator.geolocation.watchPosition(
        handlePositionUpdate,
        handleLocationError,
        {
            enableHighAccuracy: true,
            timeout: 5000,
            maximumAge: 0
        }
    );

    // Send updates at interval
    updateInterval = setInterval(sendLocationUpdate, UPDATE_INTERVAL);
}

function handlePositionUpdate(position) {
    currentPosition = position;
    
    const lat = position.coords.latitude.toFixed(6);
    const lng = position.coords.longitude.toFixed(6);
    const accuracy = position.coords.accuracy ? position.coords.accuracy.toFixed(0) + 'm' : '--';
    const speed = position.coords.speed ? (position.coords.speed * 3.6).toFixed(1) + ' km/h' : '--';

    document.getElementById('latValue').textContent = lat;
    document.getElementById('lngValue').textContent = lng;
    document.getElementById('accuracyValue').textContent = accuracy;
    document.getElementById('speedValue').textContent = speed;

    // Update mini map
    if (miniMap && driverMarker) {
        driverMarker.setLatLng([position.coords.latitude, position.coords.longitude]);
        miniMap.setView([position.coords.latitude, position.coords.longitude], 16);
    }
}

function sendLocationUpdate() {
    if (!currentPosition) return;

    const data = {
        latitude: currentPosition.coords.latitude,
        longitude: currentPosition.coords.longitude,
        accuracy: currentPosition.coords.accuracy,
        heading: currentPosition.coords.heading,
        speed: currentPosition.coords.speed
    };

    fetch('/api/location/update/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCSRFToken()
        },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(result => {
        if (result.status === 'success') {
            updateCount++;
            document.getElementById('updateCount').textContent = updateCount;
            document.getElementById('lastUpdateText').textContent = 
                'Last update: ' + new Date().toLocaleTimeString();
        }
    })
    .catch(error => {
        console.error('Failed to send location:', error);
    });
}

function stopSharing() {
    // Stop watching
    if (watchId !== null) {
        navigator.geolocation.clearWatch(watchId);
        watchId = null;
    }

    // Stop interval
    if (updateInterval) {
        clearInterval(updateInterval);
        updateInterval = null;
    }

    // Notify server
    fetch('/api/location/stop/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCSRFToken()
        }
    }).catch(err => console.log('Stop notification failed:', err));

    // Update UI
    document.getElementById('startBtn').classList.remove('d-none');
    document.getElementById('stopBtn').classList.add('d-none');
    document.getElementById('locationInfo').classList.add('d-none');
    document.getElementById('miniMapContainer').classList.add('d-none');
    
    updateStatus(false);
    updateCount = 0;
    currentPosition = null;
}

function notifyServerStart() {
    fetch('/api/location/start/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCSRFToken()
        }
    }).catch(err => console.log('Start notification failed:', err));
}

function updateStatus(isActive) {
    const indicator = document.getElementById('statusIndicator');
    const text = document.getElementById('statusText');
    
    if (isActive) {
        indicator.innerHTML = '<i class="fas fa-circle text-success fa-3x pulse-animation"></i>';
        text.textContent = 'Location Sharing Active';
        text.className = 'text-success';
    } else {
        indicator.innerHTML = '<i class="fas fa-circle text-secondary fa-3x"></i>';
        text.textContent = 'Location Sharing Inactive';
        text.className = 'text-muted';
        document.getElementById('lastUpdateText').textContent = '';
    }
}

function handleLocationError(error) {
    let message;
    switch(error.code) {
        case error.PERMISSION_DENIED:
            message = 'Location permission denied. Please enable location access in your browser settings.';
            break;
        case error.POSITION_UNAVAILABLE:
            message = 'Location information is unavailable. Please check your device settings.';
            break;
        case error.TIMEOUT:
            message = 'Location request timed out. Please try again.';
            break;
        default:
            message = 'An unknown error occurred while getting location.';
    }
    showError(message);
}

function showError(message) {
    const errorDisplay = document.getElementById('errorDisplay');
    document.getElementById('errorText').textContent = message;
    errorDisplay.classList.remove('d-none');
}

function initMiniMap() {
    if (!miniMap) {
        miniMap = L.map('miniMap').setView([0, 0], 2);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: 'Â© OpenStreetMap'
        }).addTo(miniMap);
        
        driverMarker = L.marker([0, 0], {
            icon: L.divIcon({
                className: 'driver-marker',
                html: '<i class="fas fa-user-circle" style="font-size: 24px; color: #198754;"></i>',
                iconSize: [24, 24],
                iconAnchor: [12, 12]
            })
        }).addTo(miniMap);
    }
}

// Stop sharing on page unload
window.addEventListener('beforeunload', function() {
    if (watchId !== null) {
        fetch('/api/location/stop/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCSRFToken()
            },
            keepalive: true
        });
    }
});
</script>

<style>
.pulse-animation {
    animation: pulse 2s infinite;
}

@keyframes pulse {
    0% { opacity: 1; }
    50% { opacity: 0.5; }
    100% { opacity: 1; }
}

.driver-marker {
    background: transparent;
    border: none;
}
</style>
{% endblock %}
