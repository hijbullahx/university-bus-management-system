{% extends 'base.html' %}
{% block title %}Driver Dashboard - Bus Tracking{% endblock %}
{% block content %}
<div class="container-fluid py-4">
    <!-- Header -->
    <div class="row mb-4">
        <div class="col-12 d-flex justify-content-between align-items-center">
            <div>
                <h2><i class="fas fa-id-card me-2"></i>Driver Dashboard</h2>
                <p class="text-muted mb-0">Welcome, {{ user.get_full_name|default:user.username }}</p>
            </div>
            <button class="btn btn-danger" data-bs-toggle="modal" data-bs-target="#issueModal">
                <i class="fas fa-exclamation-triangle me-2"></i>Report Issue
            </button>
        </div>
    </div>

    {% if assignment %}
    <!-- PROMINENT ASSIGNMENT INFO -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card border-0 shadow-lg bg-gradient" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
                <div class="card-body text-white p-4">
                    <div class="row align-items-center">
                        <div class="col-md-3 text-center border-end border-light-subtle">
                            <div class="mb-2">
                                <i class="fas fa-bus fa-3x"></i>
                            </div>
                            <h2 class="mb-0 fw-bold">{{ assignment.bus.bus_number }}</h2>
                            <small class="opacity-75">Assigned Bus</small>
                        </div>
                        <div class="col-md-4 text-center border-end border-light-subtle">
                            <div class="mb-2">
                                <i class="fas fa-route fa-2x"></i>
                            </div>
                            <h4 class="mb-0 fw-bold">{{ assignment.route.name }}</h4>
                            <small class="opacity-75">{{ assignment.route.get_route_type_display }}</small>
                        </div>
                        <div class="col-md-3 text-center border-end border-light-subtle">
                            <div class="mb-2">
                                <i class="fas fa-clock fa-2x"></i>
                            </div>
                            <h5 class="mb-0">
                                {% if assignment.shift_start and assignment.shift_end %}
                                {{ assignment.shift_start|time:"h:i A" }} - {{ assignment.shift_end|time:"h:i A" }}
                                {% else %}
                                All Day
                                {% endif %}
                            </h5>
                            <small class="opacity-75">Service Time</small>
                        </div>
                        <div class="col-md-2 text-center">
                            <span id="journeyStatusBadge" class="badge bg-secondary fs-6 px-3 py-2">
                                <i class="fas fa-circle me-1"></i> OFFLINE
                            </span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- JOURNEY CONTROL BUTTONS -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card shadow-sm">
                <div class="card-body text-center py-4">
                    <h5 class="mb-4"><i class="fas fa-steering-wheel me-2"></i>Journey Control</h5>
                    
                    <div id="journeyControls">
                        <!-- Start Journey Button -->
                        <button id="startJourneyBtn" class="btn btn-success btn-lg px-5 py-3" onclick="startJourney()">
                            <i class="fas fa-play-circle fa-2x mb-2 d-block"></i>
                            <span class="fw-bold">START JOURNEY</span>
                        </button>
                        
                        <!-- End Journey Button (Hidden initially) -->
                        <div id="activeJourneyControls" class="d-none">
                            <div class="row justify-content-center align-items-center g-4">
                                <div class="col-auto">
                                    <div class="text-center">
                                        <div class="spinner-grow text-success me-2" role="status"></div>
                                        <span class="text-success fw-bold fs-5">Journey Active</span>
                                        <p class="text-muted mb-0 mt-1">
                                            Started: <span id="journeyStartTime">--:--</span>
                                            | Duration: <span id="journeyDuration">0 min</span>
                                        </p>
                                    </div>
                                </div>
                                <div class="col-auto">
                                    <button id="endJourneyBtn" class="btn btn-danger btn-lg px-5 py-3" onclick="endJourney()">
                                        <i class="fas fa-stop-circle fa-2x mb-2 d-block"></i>
                                        <span class="fw-bold">END JOURNEY</span>
                                    </button>
                                </div>
                                <div class="col-auto">
                                    <button class="btn btn-warning btn-lg px-4 py-3" onclick="reportDelay()">
                                        <i class="fas fa-clock fa-2x mb-2 d-block"></i>
                                        <span class="fw-bold">Report Delay</span>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div id="locationPermissionAlert" class="alert alert-warning mt-4 d-none">
                        <i class="fas fa-location-arrow me-2"></i>
                        <strong>Location Permission Required:</strong> Please allow location access to start your journey.
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Route Stops -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card shadow-sm">
                <div class="card-header bg-primary text-white">
                    <i class="fas fa-map-marked-alt me-2"></i>Route Stops
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-hover mb-0">
                            <thead class="table-light">
                                <tr>
                                    <th width="60">#</th>
                                    <th>Stop Name</th>
                                    <th>Scheduled Time</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for stop in assignment.route.stops.all %}
                                <tr>
                                    <td>
                                        <span class="badge bg-primary rounded-circle">{{ forloop.counter }}</span>
                                    </td>
                                    <td>
                                        <i class="fas fa-map-pin text-danger me-2"></i>{{ stop.name }}
                                        {% if stop.is_major_stop %}
                                        <span class="badge bg-success ms-2">Major</span>
                                        {% endif %}
                                    </td>
                                    <td>{{ stop.scheduled_time|time:"h:i A"|default:"-" }}</td>
                                </tr>
                                {% empty %}
                                <tr>
                                    <td colspan="3" class="text-center text-muted">No stops configured</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    {% else %}
    <!-- No Assignment Alert -->
    <div class="row">
        <div class="col-12">
            <div class="alert alert-info d-flex align-items-center">
                <i class="fas fa-info-circle fa-2x me-3"></i>
                <div>
                    <h5 class="mb-1">No Active Assignment</h5>
                    <p class="mb-0">You don't have any active bus assignment. Please contact the administrator.</p>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Recent Issues -->
    <div class="row">
        <div class="col-12">
            <div class="card shadow-sm">
                <div class="card-header bg-secondary text-white">
                    <i class="fas fa-exclamation-circle me-2"></i>Recent Issues Reported
                </div>
                <div class="card-body">
                    {% if recent_issues %}
                    <div class="table-responsive">
                        <table class="table table-hover mb-0">
                            <thead class="table-light">
                                <tr>
                                    <th>Type</th>
                                    <th>Description</th>
                                    <th>Status</th>
                                    <th>Date</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for issue in recent_issues %}
                                <tr>
                                    <td><span class="badge bg-warning text-dark">{{ issue.get_issue_type_display }}</span></td>
                                    <td>{{ issue.description|truncatechars:50 }}</td>
                                    <td>
                                        <span class="badge bg-{% if issue.status == 'resolved' %}success{% elif issue.status == 'in_progress' %}primary{% else %}secondary{% endif %}">
                                            {{ issue.get_status_display }}
                                        </span>
                                    </td>
                                    <td>{{ issue.created_at|date:"M d, H:i" }}</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% else %}
                    <p class="text-muted text-center mb-0">No recent issues</p>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Issue Report Modal -->
<div class="modal fade" id="issueModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title"><i class="fas fa-exclamation-triangle me-2"></i>Report Issue</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <form id="issueForm" method="post" action="{% url 'issues:create' %}">
                {% csrf_token %}
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Issue Type</label>
                        <select name="issue_type" class="form-select" required>
                            <option value="mechanical">Mechanical Breakdown</option>
                            <option value="traffic">Heavy Traffic Delay</option>
                            <option value="emergency">Emergency</option>
                            <option value="other">Other</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Description</label>
                        <textarea name="description" class="form-control" rows="3" placeholder="Provide details..."></textarea>
                    </div>
                    <input type="hidden" name="latitude" id="issueLatitude">
                    <input type="hidden" name="longitude" id="issueLongitude">
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-danger">Submit Report</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Delay Report Modal -->
<div class="modal fade" id="delayModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-warning">
                <h5 class="modal-title"><i class="fas fa-clock me-2"></i>Report Delay</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label class="form-label">Estimated Delay (minutes)</label>
                    <select id="delayMinutes" class="form-select">
                        <option value="5">5 minutes</option>
                        <option value="10" selected>10 minutes</option>
                        <option value="15">15 minutes</option>
                        <option value="20">20 minutes</option>
                        <option value="30">30 minutes</option>
                        <option value="45">45 minutes</option>
                        <option value="60">1 hour+</option>
                    </select>
                </div>
                <div class="mb-3">
                    <label class="form-label">Reason (Optional)</label>
                    <textarea id="delayReason" class="form-control" rows="2" placeholder="e.g., Heavy traffic, Road work..."></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-warning" onclick="submitDelay()">Report Delay</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
const csrfToken = '{{ csrf_token }}';
let watchId = null;
let journeyStartTime = null;
let durationInterval = null;

// Check existing journey status on page load
document.addEventListener('DOMContentLoaded', function() {
    checkJourneyStatus();
});

async function checkJourneyStatus() {
    try {
        const response = await fetch('/api/locations/location/status/', {
            headers: { 'X-CSRFToken': csrfToken }
        });
        const data = await response.json();
        
        if (data.has_active_journey) {
            showActiveJourneyUI(data.journey_start);
        }
    } catch (error) {
        console.error('Error checking journey status:', error);
    }
}

function showActiveJourneyUI(startTime) {
    document.getElementById('startJourneyBtn').classList.add('d-none');
    document.getElementById('activeJourneyControls').classList.remove('d-none');
    document.getElementById('journeyStatusBadge').innerHTML = '<i class="fas fa-circle me-1"></i> ON JOURNEY';
    document.getElementById('journeyStatusBadge').className = 'badge bg-success fs-6 px-3 py-2';
    
    journeyStartTime = new Date(startTime);
    document.getElementById('journeyStartTime').textContent = journeyStartTime.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
    
    // Start duration counter
    updateDuration();
    durationInterval = setInterval(updateDuration, 60000);
    
    // Resume location tracking
    startLocationTracking();
}

function showOfflineUI() {
    document.getElementById('startJourneyBtn').classList.remove('d-none');
    document.getElementById('activeJourneyControls').classList.add('d-none');
    document.getElementById('journeyStatusBadge').innerHTML = '<i class="fas fa-circle me-1"></i> OFFLINE';
    document.getElementById('journeyStatusBadge').className = 'badge bg-secondary fs-6 px-3 py-2';
    
    if (durationInterval) {
        clearInterval(durationInterval);
    }
}

function updateDuration() {
    if (journeyStartTime) {
        const now = new Date();
        const diffMs = now - journeyStartTime;
        const diffMins = Math.floor(diffMs / 60000);
        document.getElementById('journeyDuration').textContent = diffMins + ' min';
    }
}

async function startJourney() {
    // Request location permission
    if (!navigator.geolocation) {
        alert('Geolocation is not supported by your browser.');
        return;
    }
    
    document.getElementById('locationPermissionAlert').classList.add('d-none');
    
    navigator.geolocation.getCurrentPosition(
        async (position) => {
            try {
                const response = await fetch('/api/locations/journey/start/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': csrfToken
                    },
                    body: JSON.stringify({
                        latitude: position.coords.latitude,
                        longitude: position.coords.longitude
                    })
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    showActiveJourneyUI(new Date().toISOString());
                    showToast('Journey started successfully!', 'success');
                } else {
                    alert(data.error || 'Failed to start journey');
                }
            } catch (error) {
                console.error('Error starting journey:', error);
                alert('Error starting journey. Please try again.');
            }
        },
        (error) => {
            console.error('Location error:', error);
            document.getElementById('locationPermissionAlert').classList.remove('d-none');
        },
        { enableHighAccuracy: true, timeout: 10000 }
    );
}

async function endJourney() {
    if (!confirm('Are you sure you want to end this journey?')) return;
    
    // Stop location tracking
    if (watchId) {
        navigator.geolocation.clearWatch(watchId);
        watchId = null;
    }
    
    // Get final position
    navigator.geolocation.getCurrentPosition(
        async (position) => {
            try {
                const response = await fetch('/api/locations/journey/end/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': csrfToken
                    },
                    body: JSON.stringify({
                        latitude: position.coords.latitude,
                        longitude: position.coords.longitude
                    })
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    showOfflineUI();
                    showToast(`Journey ended. Duration: ${data.duration_minutes} minutes`, 'info');
                } else {
                    alert(data.error || 'Failed to end journey');
                }
            } catch (error) {
                console.error('Error ending journey:', error);
            }
        },
        async () => {
            // End without location if permission denied
            try {
                const response = await fetch('/api/locations/journey/end/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': csrfToken
                    }
                });
                showOfflineUI();
            } catch (error) {
                console.error('Error ending journey:', error);
            }
        }
    );
}

function startLocationTracking() {
    if (watchId) return; // Already tracking
    
    watchId = navigator.geolocation.watchPosition(
        async (position) => {
            await sendLocation(position.coords);
        },
        (error) => {
            console.error('Location tracking error:', error);
        },
        { enableHighAccuracy: true, maximumAge: 5000, timeout: 10000 }
    );
}

async function sendLocation(coords) {
    try {
        await fetch('/api/locations/location/update/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrfToken
            },
            body: JSON.stringify({
                latitude: coords.latitude,
                longitude: coords.longitude,
                accuracy: coords.accuracy,
                heading: coords.heading,
                speed: coords.speed
            })
        });
    } catch (error) {
        console.error('Error sending location:', error);
    }
}

function reportDelay() {
    const modal = new bootstrap.Modal(document.getElementById('delayModal'));
    modal.show();
}

async function submitDelay() {
    const delayMinutes = document.getElementById('delayMinutes').value;
    const reason = document.getElementById('delayReason').value;
    
    try {
        const response = await fetch('/api/locations/journey/delay/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrfToken
            },
            body: JSON.stringify({
                delay_minutes: parseInt(delayMinutes),
                reason: reason
            })
        });
        
        if (response.ok) {
            bootstrap.Modal.getInstance(document.getElementById('delayModal')).hide();
            showToast('Delay reported successfully', 'warning');
        }
    } catch (error) {
        console.error('Error reporting delay:', error);
    }
}

function showToast(message, type) {
    // Simple alert fallback - can be replaced with toast library
    alert(message);
}

// Handle page unload - stop sharing
window.addEventListener('beforeunload', function() {
    if (watchId) {
        navigator.sendBeacon('/api/locations/journey/end/', JSON.stringify({}));
    }
});

// Issue modal location
document.getElementById('issueModal').addEventListener('show.bs.modal', function() {
    if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(position => {
            document.getElementById('issueLatitude').value = position.coords.latitude;
            document.getElementById('issueLongitude').value = position.coords.longitude;
        });
    }
});
</script>
{% endblock %}
