{% extends 'base.html' %}
{% block title %}Live Bus Map - Bus Tracking{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<style>
    #fullscreen-map {
        position: fixed;
        top: 56px;
        left: 0;
        right: 0;
        bottom: 60px;
        z-index: 100;
    }
    .bottom-nav {
        position: fixed;
        bottom: 0;
        left: 0;
        right: 0;
        height: 60px;
        background: white;
        box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
        z-index: 101;
        display: flex;
        justify-content: space-around;
        align-items: center;
    }
    .bottom-nav a {
        display: flex;
        flex-direction: column;
        align-items: center;
        text-decoration: none;
        color: #6c757d;
        font-size: 12px;
    }
    .bottom-nav a.active {
        color: #0d6efd;
    }
    .bottom-nav a i {
        font-size: 24px;
    }
    .route-filter {
        position: absolute;
        top: 10px;
        left: 10px;
        z-index: 1000;
        background: white;
        padding: 10px;
        border-radius: 8px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.2);
    }
    .bus-info-panel {
        position: absolute;
        bottom: 70px;
        left: 10px;
        right: 10px;
        z-index: 1000;
        background: white;
        padding: 15px;
        border-radius: 12px;
        box-shadow: 0 -2px 15px rgba(0,0,0,0.2);
        display: none;
    }
    .bus-info-panel.active {
        display: block;
    }
    .legend {
        position: absolute;
        bottom: 80px;
        right: 10px;
        z-index: 1000;
        background: white;
        padding: 10px;
        border-radius: 8px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.2);
        font-size: 12px;
    }
    .bus-marker-long {
        background: #0d6efd;
        border-radius: 4px;
        padding: 2px 6px;
        color: white;
        font-weight: bold;
        font-size: 10px;
        white-space: nowrap;
    }
    .bus-marker-shuttle {
        background: #198754;
        border-radius: 4px;
        padding: 2px 6px;
        color: white;
        font-weight: bold;
        font-size: 10px;
        white-space: nowrap;
    }
</style>
{% endblock %}

{% block content %}
<div id="fullscreen-map"></div>

<div class="route-filter">
    <select id="routeFilter" class="form-select form-select-sm" style="min-width: 150px;">
        <option value="all">All Routes</option>
        <option value="long">Long Routes</option>
        <option value="shuttle">Shuttle</option>
    </select>
</div>

<div class="legend">
    <div class="mb-1"><span class="badge bg-primary">●</span> Long Route Bus</div>
    <div class="mb-1"><span class="badge bg-success">●</span> Shuttle Bus</div>
    <div><span class="badge bg-warning text-dark">●</span> Driver Location</div>
</div>

<div id="busInfoPanel" class="bus-info-panel">
    <div class="d-flex justify-content-between align-items-start">
        <div>
            <h5 id="busId" class="mb-1">Bus #123</h5>
            <p id="busRoute" class="text-muted mb-2">Route: Long Route - Azampur</p>
        </div>
        <button type="button" class="btn-close" onclick="closeBusPanel()"></button>
    </div>
    <div class="row text-center mb-3">
        <div class="col-4">
            <div class="text-primary fs-4" id="busETA">5 min</div>
            <small class="text-muted">ETA</small>
        </div>
        <div class="col-4">
            <div class="text-success fs-4" id="busSpeed">35</div>
            <small class="text-muted">km/h</small>
        </div>
        <div class="col-4">
            <div class="text-warning fs-4" id="busNextStop">Stop 3</div>
            <small class="text-muted">Next Stop</small>
        </div>
    </div>
    <button id="followBusBtn" class="btn btn-primary w-100" onclick="toggleFollowBus()">
        <i class="fas fa-crosshairs me-2"></i>Follow This Bus
    </button>
</div>

<div class="bottom-nav">
    <a href="{% url 'accounts:dashboard' %}">
        <i class="fas fa-home"></i>
        <span>Home</span>
    </a>
    <a href="{% url 'buses:live_map' %}" class="active">
        <i class="fas fa-map-marked-alt"></i>
        <span>Live Map</span>
    </a>
    <a href="{% url 'schedules:user_schedules' %}">
        <i class="fas fa-clock"></i>
        <span>Schedules</span>
    </a>
    <a href="{% url 'accounts:profile' %}">
        <i class="fas fa-user"></i>
        <span>Profile</span>
    </a>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Initialize map centered on Dhaka
    const map = L.map('fullscreen-map').setView([23.8103, 90.4125], 13);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '© OpenStreetMap'
    }).addTo(map);

    let busMarkers = {};
    let driverMarkers = {};
    let selectedBus = null;
    let followingBus = null;
    let currentFilter = 'all';

    // Create bus icon based on type
    function createBusIcon(busType, busNumber) {
        const colorClass = busType === 'shuttle' ? 'bus-marker-shuttle' : 'bus-marker-long';
        return L.divIcon({
            html: `<div class="${colorClass}"><i class="fas fa-bus me-1"></i>${busNumber}</div>`,
            className: 'custom-bus-marker',
            iconSize: [80, 24],
            iconAnchor: [40, 12]
        });
    }

    function createDriverIcon() {
        return L.divIcon({
            html: '<div style="background: #ffc107; border-radius: 50%; width: 20px; height: 20px; display: flex; align-items: center; justify-content: center;"><i class="fas fa-user" style="font-size: 10px; color: #333;"></i></div>',
            className: 'driver-marker',
            iconSize: [20, 20],
            iconAnchor: [10, 10]
        });
    }

    function updateBusLocations() {
        fetch('/api/buses/locations/')
            .then(response => response.json())
            .then(data => {
                data.forEach(bus => {
                    // Filter by route type
                    if (currentFilter !== 'all' && bus.bus_type !== currentFilter) {
                        if (busMarkers[bus.id]) {
                            map.removeLayer(busMarkers[bus.id]);
                            delete busMarkers[bus.id];
                        }
                        return;
                    }

                    const icon = createBusIcon(bus.bus_type || 'long', bus.bus_number);
                    
                    if (busMarkers[bus.id]) {
                        busMarkers[bus.id].setLatLng([bus.latitude, bus.longitude]);
                        busMarkers[bus.id].setIcon(icon);
                    } else {
                        busMarkers[bus.id] = L.marker([bus.latitude, bus.longitude], {icon: icon})
                            .addTo(map)
                            .on('click', () => showBusInfo(bus));
                    }

                    // Update bus info object
                    busMarkers[bus.id].busData = bus;

                    // Follow selected bus
                    if (followingBus === bus.id) {
                        map.panTo([bus.latitude, bus.longitude]);
                    }
                });
            })
            .catch(err => console.log('Error fetching bus locations'));
    }

    function updateDriverLocations() {
        fetch('/api/location/active/')
            .then(response => response.json())
            .then(data => {
                const activeIds = new Set();
                data.forEach(driver => {
                    activeIds.add(driver.id);
                    const icon = createDriverIcon();
                    
                    if (driverMarkers[driver.id]) {
                        driverMarkers[driver.id].setLatLng([driver.latitude, driver.longitude]);
                    } else {
                        driverMarkers[driver.id] = L.marker([driver.latitude, driver.longitude], {icon: icon})
                            .addTo(map)
                            .bindPopup(`<strong>Driver: ${driver.driver_name}</strong>`);
                    }
                });

                // Remove inactive drivers
                Object.keys(driverMarkers).forEach(id => {
                    if (!activeIds.has(parseInt(id))) {
                        map.removeLayer(driverMarkers[id]);
                        delete driverMarkers[id];
                    }
                });
            })
            .catch(err => console.log('Error fetching driver locations'));
    }

    window.showBusInfo = function(bus) {
        selectedBus = bus.id;
        document.getElementById('busId').textContent = `Bus #${bus.bus_number}`;
        document.getElementById('busRoute').textContent = `Route: ${bus.route_name || 'N/A'}`;
        document.getElementById('busETA').textContent = bus.eta || 'N/A';
        document.getElementById('busSpeed').textContent = bus.speed || '0';
        document.getElementById('busNextStop').textContent = bus.next_stop || 'N/A';
        document.getElementById('busInfoPanel').classList.add('active');
        
        if (followingBus === bus.id) {
            document.getElementById('followBusBtn').innerHTML = '<i class="fas fa-times me-2"></i>Stop Following';
            document.getElementById('followBusBtn').classList.remove('btn-primary');
            document.getElementById('followBusBtn').classList.add('btn-danger');
        } else {
            document.getElementById('followBusBtn').innerHTML = '<i class="fas fa-crosshairs me-2"></i>Follow This Bus';
            document.getElementById('followBusBtn').classList.remove('btn-danger');
            document.getElementById('followBusBtn').classList.add('btn-primary');
        }
    };

    window.closeBusPanel = function() {
        document.getElementById('busInfoPanel').classList.remove('active');
        selectedBus = null;
    };

    window.toggleFollowBus = function() {
        if (followingBus === selectedBus) {
            followingBus = null;
            document.getElementById('followBusBtn').innerHTML = '<i class="fas fa-crosshairs me-2"></i>Follow This Bus';
            document.getElementById('followBusBtn').classList.remove('btn-danger');
            document.getElementById('followBusBtn').classList.add('btn-primary');
        } else {
            followingBus = selectedBus;
            document.getElementById('followBusBtn').innerHTML = '<i class="fas fa-times me-2"></i>Stop Following';
            document.getElementById('followBusBtn').classList.remove('btn-primary');
            document.getElementById('followBusBtn').classList.add('btn-danger');
        }
    };

    // Route filter
    document.getElementById('routeFilter').addEventListener('change', function() {
        currentFilter = this.value;
        // Clear all markers and refresh
        Object.values(busMarkers).forEach(marker => map.removeLayer(marker));
        busMarkers = {};
        updateBusLocations();
    });

    // Initial load and auto-refresh
    updateBusLocations();
    updateDriverLocations();
    setInterval(updateBusLocations, 5000);
    setInterval(updateDriverLocations, 5000);
});
</script>
{% endblock %}
