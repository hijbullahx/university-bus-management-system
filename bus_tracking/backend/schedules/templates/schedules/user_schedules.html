{% extends 'base.html' %}
{% block title %}Bus Schedules - Bus Tracking{% endblock %}

{% block extra_css %}
<style>
    .route-card {
        cursor: pointer;
        transition: all 0.3s ease;
        border-left: 4px solid #0d6efd;
    }
    .route-card.shuttle {
        border-left-color: #198754;
    }
    .route-card:hover {
        box-shadow: 0 4px 15px rgba(0,0,0,0.15);
        transform: translateY(-2px);
    }
    .route-card.expanded {
        box-shadow: 0 4px 20px rgba(0,0,0,0.2);
    }
    .stops-list {
        display: none;
        animation: slideDown 0.3s ease;
    }
    .stops-list.show {
        display: block;
    }
    @keyframes slideDown {
        from { opacity: 0; transform: translateY(-10px); }
        to { opacity: 1; transform: translateY(0); }
    }
    .stop-item {
        padding: 12px 15px;
        border-bottom: 1px solid #f0f0f0;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    .stop-item:last-child {
        border-bottom: none;
    }
    .stop-name {
        display: flex;
        align-items: center;
    }
    .stop-number {
        width: 28px;
        height: 28px;
        background: #e9ecef;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 12px;
        font-weight: bold;
        margin-right: 12px;
    }
    .stop-number.major {
        background: #0d6efd;
        color: white;
    }
    .time-scheduled {
        color: #6c757d;
        font-size: 14px;
    }
    .time-eta {
        font-weight: bold;
        font-size: 16px;
    }
    .time-eta.on-time {
        color: #198754;
    }
    .time-eta.delayed {
        color: #dc3545;
    }
    .bottom-nav {
        position: fixed;
        bottom: 0;
        left: 0;
        right: 0;
        height: 60px;
        background: white;
        box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
        z-index: 101;
        display: flex;
        justify-content: space-around;
        align-items: center;
    }
    .bottom-nav a {
        display: flex;
        flex-direction: column;
        align-items: center;
        text-decoration: none;
        color: #6c757d;
        font-size: 12px;
    }
    .bottom-nav a.active {
        color: #0d6efd;
    }
    .bottom-nav a i {
        font-size: 24px;
    }
    .content-area {
        padding-bottom: 80px;
    }
    .search-box {
        position: sticky;
        top: 56px;
        z-index: 100;
        background: #f8f9fa;
        padding: 15px;
        margin: -15px -15px 15px -15px;
    }
    .route-type-badge {
        font-size: 10px;
        padding: 3px 8px;
    }
    .trip-section {
        background: #f8f9fa;
        padding: 10px 15px;
        margin-top: 10px;
        border-radius: 8px;
    }
    .trip-header {
        font-weight: 600;
        color: #495057;
        cursor: pointer;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid py-3 content-area">
    <div class="search-box">
        <div class="input-group">
            <span class="input-group-text bg-white"><i class="fas fa-search"></i></span>
            <input type="text" id="searchBox" class="form-control" placeholder="Search routes or stops...">
        </div>
        <div class="mt-2 d-flex gap-2">
            <button class="btn btn-sm btn-outline-primary filter-btn active" data-filter="all">All</button>
            <button class="btn btn-sm btn-outline-primary filter-btn" data-filter="long">Long Routes</button>
            <button class="btn btn-sm btn-outline-success filter-btn" data-filter="shuttle">Shuttle</button>
        </div>
    </div>

    <div id="routesList">
        {% for route in routes %}
        <div class="card route-card mb-3 {% if route.route_type == 'shuttle' %}shuttle{% endif %}" 
             data-route-id="{{ route.id }}" 
             data-route-type="{{ route.route_type }}"
             data-route-name="{{ route.name|lower }}">
            <div class="card-body" onclick="toggleRoute({{ route.id }})">
                <div class="d-flex justify-content-between align-items-start">
                    <div>
                        <h5 class="card-title mb-1">
                            {{ route.name }}
                            <span class="badge route-type-badge {% if route.route_type == 'shuttle' %}bg-success{% else %}bg-primary{% endif %}">
                                {{ route.get_route_type_display }}
                            </span>
                        </h5>
                        <p class="card-text text-muted mb-0 small">{{ route.description|truncatechars:60 }}</p>
                    </div>
                    <div class="text-end">
                        <span class="badge bg-secondary">{{ route.stops.count }} stops</span>
                        <i class="fas fa-chevron-down ms-2 toggle-icon"></i>
                    </div>
                </div>
            </div>
            <div class="stops-list" id="stops-{{ route.id }}">
                {% if route.trips.all %}
                    {% for trip in route.trips.all %}
                    <div class="trip-section">
                        <div class="trip-header" onclick="event.stopPropagation();">
                            <span><i class="fas fa-clock me-2"></i>{{ trip.name }} ({{ trip.departure_time|time:"H:i" }})</span>
                            <span class="badge bg-{{ trip.trip_type }}">{{ trip.get_trip_type_display }}</span>
                        </div>
                        <div class="mt-2">
                            {% for stop_time in trip.stop_times.all %}
                            <div class="stop-item">
                                <div class="stop-name">
                                    <div class="stop-number {% if stop_time.stop.is_major_stop %}major{% endif %}">{{ forloop.counter }}</div>
                                    <div>
                                        <div>{{ stop_time.stop.name }}</div>
                                        {% if stop_time.stop.is_major_stop %}
                                        <small class="text-muted"><i class="fas fa-star text-warning"></i> Major Stop</small>
                                        {% endif %}
                                    </div>
                                </div>
                                <div class="text-end">
                                    <div class="time-scheduled">{{ stop_time.arrival_time|time:"H:i" }}</div>
                                    <div class="time-eta on-time" data-stop-id="{{ stop_time.stop.id }}" data-bus-route="{{ route.id }}">
                                        --:--
                                    </div>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                    {% endfor %}
                {% else %}
                    <!-- Fallback to basic stops if no trips defined -->
                    {% for stop in route.stops.all %}
                    <div class="stop-item">
                        <div class="stop-name">
                            <div class="stop-number {% if stop.is_major_stop %}major{% endif %}">{{ forloop.counter }}</div>
                            <div>
                                <div>{{ stop.name }}</div>
                                {% if stop.is_major_stop %}
                                <small class="text-muted"><i class="fas fa-star text-warning"></i> Major Stop</small>
                                {% endif %}
                            </div>
                        </div>
                        <div class="text-end">
                            <div class="time-scheduled">{{ stop.scheduled_time|time:"H:i"|default:"--:--" }}</div>
                            <div class="time-eta on-time" data-stop-id="{{ stop.id }}">--:--</div>
                        </div>
                    </div>
                    {% endfor %}
                {% endif %}
            </div>
        </div>
        {% empty %}
        <div class="alert alert-info text-center">
            <i class="fas fa-info-circle me-2"></i>No routes available at the moment.
        </div>
        {% endfor %}
    </div>
</div>

<div class="bottom-nav">
    <a href="{% url 'accounts:dashboard' %}">
        <i class="fas fa-home"></i>
        <span>Home</span>
    </a>
    <a href="{% url 'buses:live_map' %}">
        <i class="fas fa-map-marked-alt"></i>
        <span>Live Map</span>
    </a>
    <a href="{% url 'schedules:user_schedules' %}" class="active">
        <i class="fas fa-clock"></i>
        <span>Schedules</span>
    </a>
    <a href="{% url 'accounts:profile' %}">
        <i class="fas fa-user"></i>
        <span>Profile</span>
    </a>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Toggle route expansion
    window.toggleRoute = function(routeId) {
        const stopsList = document.getElementById('stops-' + routeId);
        const card = document.querySelector(`[data-route-id="${routeId}"]`);
        const icon = card.querySelector('.toggle-icon');
        
        if (stopsList.classList.contains('show')) {
            stopsList.classList.remove('show');
            card.classList.remove('expanded');
            icon.style.transform = 'rotate(0deg)';
        } else {
            stopsList.classList.add('show');
            card.classList.add('expanded');
            icon.style.transform = 'rotate(180deg)';
        }
    };

    // Search functionality
    document.getElementById('searchBox').addEventListener('input', function() {
        const searchTerm = this.value.toLowerCase();
        document.querySelectorAll('.route-card').forEach(card => {
            const routeName = card.dataset.routeName;
            const stops = card.querySelectorAll('.stop-item');
            let hasMatch = routeName.includes(searchTerm);
            
            stops.forEach(stop => {
                const stopName = stop.querySelector('.stop-name div div').textContent.toLowerCase();
                if (stopName.includes(searchTerm)) {
                    hasMatch = true;
                }
            });
            
            card.style.display = hasMatch ? 'block' : 'none';
        });
    });

    // Filter buttons
    document.querySelectorAll('.filter-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
            this.classList.add('active');
            
            const filter = this.dataset.filter;
            document.querySelectorAll('.route-card').forEach(card => {
                if (filter === 'all' || card.dataset.routeType === filter) {
                    card.style.display = 'block';
                } else {
                    card.style.display = 'none';
                }
            });
        });
    });

    // Fetch live ETAs
    function updateLiveETAs() {
        fetch('/api/buses/etas/')
            .then(response => response.json())
            .then(data => {
                data.forEach(eta => {
                    const etaElements = document.querySelectorAll(`[data-stop-id="${eta.stop_id}"]`);
                    etaElements.forEach(el => {
                        el.textContent = eta.eta_time;
                        el.classList.remove('on-time', 'delayed');
                        el.classList.add(eta.delay_minutes > 3 ? 'delayed' : 'on-time');
                    });
                });
            })
            .catch(err => console.log('Error fetching ETAs'));
    }

    updateLiveETAs();
    setInterval(updateLiveETAs, 30000);
});
</script>
{% endblock %}
