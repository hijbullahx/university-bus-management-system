{% extends 'base.html' %}
{% block title %}{{ route.name }} - Bus Tracking{% endblock %}
{% block content %}
<div class="container-fluid py-4">
    <div class="row mb-4">
        <div class="col-12">
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item"><a href="{% url 'schedules:route_list' %}">Routes</a></li>
                    <li class="breadcrumb-item active">{{ route.name }}</li>
                </ol>
            </nav>
        </div>
    </div>

    <div class="row mb-4">
        <div class="col-md-4">
            <div class="card shadow" style="border-left: 5px solid {{ route.color }};">
                <div class="card-header bg-white d-flex justify-content-between align-items-center">
                    <h4 class="mb-0">{{ route.name }}</h4>
                    <span class="badge bg-{% if route.route_type == 'shuttle' %}success{% else %}primary{% endif %}">
                        {{ route.get_route_type_display }}
                    </span>
                </div>
                <div class="card-body">
                    <p>{{ route.description|default:"No description" }}</p>
                    <table class="table table-borderless table-sm">
                        <tr>
                            <th>Status:</th>
                            <td>
                                <span class="badge bg-{{ route.is_active|yesno:'success,danger' }}">
                                    {{ route.is_active|yesno:'Active,Inactive' }}
                                </span>
                            </td>
                        </tr>
                        <tr>
                            <th>Published:</th>
                            <td>
                                <span class="badge bg-{{ route.is_published|yesno:'success,warning' }}">
                                    {{ route.is_published|yesno:'Published,Draft' }}
                                </span>
                            </td>
                        </tr>
                        {% if route.current_buses.exists %}
                        <tr>
                            <th>Assigned Bus:</th>
                            <td>
                                {% for bus in route.current_buses.all %}
                                <span class="badge bg-primary">{{ bus.bus_number }}</span>
                                {% endfor %}
                            </td>
                        </tr>
                        {% endif %}
                        {% for assignment in route.assignments.all %}
                        {% if assignment.is_active %}
                        <tr>
                            <th>Driver:</th>
                            <td>{{ assignment.driver.get_full_name|default:assignment.driver.username }}</td>
                        </tr>
                        {% endif %}
                        {% endfor %}
                        <tr>
                            <th>Total Stops:</th>
                            <td>{{ stops.count }}</td>
                        </tr>
                        {% if route.total_distance_km %}
                        <tr>
                            <th>Distance:</th>
                            <td>{{ route.total_distance_km }} km</td>
                        </tr>
                        {% endif %}
                        {% if route.estimated_duration_mins %}
                        <tr>
                            <th>Duration:</th>
                            <td>~{{ route.estimated_duration_mins }} mins</td>
                        </tr>
                        {% endif %}
                    </table>
                    {% if user.is_admin_user %}
                    <div class="d-grid gap-2">
                        {% if route.is_published %}
                        <form method="post" action="{% url 'schedules:unpublish_route' route.id %}">
                            {% csrf_token %}
                            <button type="submit" class="btn btn-warning w-100">
                                <i class="fas fa-eye-slash me-2"></i>Unpublish Route
                            </button>
                        </form>
                        {% else %}
                        <form method="post" action="{% url 'schedules:publish_route' route.id %}">
                            {% csrf_token %}
                            <button type="submit" class="btn btn-success w-100">
                                <i class="fas fa-globe me-2"></i>Publish Route
                            </button>
                        </form>
                        {% endif %}
                        <a href="{% url 'schedules:route_edit' route.id %}" class="btn btn-outline-primary">
                            <i class="bi bi-pencil me-2"></i>Edit Route
                        </a>
                        <a href="{% url 'schedules:route_delete' route.id %}" class="btn btn-outline-danger">
                            <i class="bi bi-trash me-2"></i>Delete Route
                        </a>
                    </div>
                    {% endif %}
                </div>
            </div>
            
            {% if active_buses %}
            <div class="card shadow-sm mt-3">
                <div class="card-header bg-success text-white">
                    <i class="bi bi-bus-front me-2"></i>Active Buses
                </div>
                <div class="card-body p-0">
                    <ul class="list-group list-group-flush">
                        {% for bus in active_buses %}
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                            <a href="{% url 'buses:follow_bus' bus.id %}">{{ bus.bus_number }}</a>
                            <span class="badge bg-success">Active</span>
                        </li>
                        {% endfor %}
                    </ul>
                </div>
            </div>
            {% endif %}
        </div>
        
        <div class="col-md-8">
            <div class="card shadow-sm mb-4">
                <div class="card-header bg-dark text-white">
                    <i class="bi bi-map me-2"></i>Route Map
                </div>
                <div class="card-body p-0">
                    <div id="routeMap" style="height: 300px;"></div>
                </div>
            </div>
            
            <div class="card shadow-sm">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <span><i class="bi bi-geo-alt me-2"></i>Stops</span>
                    <span class="badge bg-primary">{{ stops.count }} stops</span>
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-hover mb-0">
                            <thead class="table-light">
                                <tr>
                                    <th width="50">#</th>
                                    <th>Stop Name</th>
                                    <th>Scheduled Time</th>
                                    <th>Live ETA</th>
                                    <th>Status</th>
                                    {% if user.is_admin_user %}<th>Actions</th>{% endif %}
                                </tr>
                            </thead>
                            <tbody id="stopsTableBody">
                                {% for stop in stops %}
                                <tr>
                                    <td><span class="badge bg-secondary">{{ stop.order }}</span></td>
                                    <td>
                                        {{ stop.name }}
                                        {% if stop.is_major_stop %}
                                        <i class="bi bi-star-fill text-warning ms-1" title="Major Stop"></i>
                                        {% endif %}
                                    </td>
                                    <td class="text-muted">{{ stop.scheduled_time|time:"H:i"|default:"-" }}</td>
                                    <td class="fw-bold" id="eta-{{ stop.id }}">-</td>
                                    <td id="status-{{ stop.id }}">
                                        <span class="badge bg-secondary">Pending</span>
                                    </td>
                                    {% if user.is_admin_user %}
                                    <td>
                                        <a href="{% url 'schedules:stop_edit' stop.id %}" class="btn btn-sm btn-outline-secondary">
                                            <i class="bi bi-pencil me-1"></i> Edit
                                        </a>
                                        <a href="{% url 'schedules:stop_delete' stop.id %}" class="btn btn-sm btn-outline-danger">
                                            <i class="bi bi-trash me-1"></i> Delete
                                        </a>
                                    </td>
                                    {% endif %}
                                </tr>
                                {% empty %}
                                <tr>
                                    <td colspan="6" class="text-center text-muted py-4">No stops configured</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Trips Section -->
    <div class="row mt-4">
        <div class="col-12">
            <div class="card shadow-sm">
                <div class="card-header d-flex justify-content-between align-items-center bg-info text-white">
                    <span><i class="fas fa-clock me-2"></i>Trip Schedule</span>
                    {% if user.is_admin_user %}
                    <a href="{% url 'schedules:route_edit' route.id %}" class="btn btn-light btn-sm">
                        <i class="fas fa-edit me-1"></i>Edit Trips
                    </a>
                    {% endif %}
                </div>
                <div class="card-body">
                    {% if route.is_shuttle_or_metro %}
                    <!-- Shuttle/Metro Style Display -->
                    {% if route.origin_name or route.destination_name %}
                    <div class="alert alert-light border mb-3">
                        <strong>Route:</strong> {{ route.origin_name|default:"Origin" }} 
                        <i class="fas fa-arrow-right mx-2"></i> 
                        {{ route.destination_name|default:"Destination" }}
                        {% if route.service_days %}
                        <span class="float-end">
                            <strong>Service Days:</strong> {{ route.get_service_days_display }}
                        </span>
                        {% endif %}
                    </div>
                    {% endif %}
                    <div class="table-responsive">
                        <table class="table table-hover table-bordered">
                            <thead class="table-primary">
                                <tr>
                                    <th style="width: 100px;">Trip No</th>
                                    <th>Campus Time</th>
                                    <th>Destination Time</th>
                                    <th>Status</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for trip in route.trips.all %}
                                <tr>
                                    <td class="text-center">
                                        <span class="badge bg-primary fs-6">{{ trip.formatted_trip_number }}</span>
                                    </td>
                                    <td><strong>{{ trip.departure_time|time:"h:i A" }}</strong></td>
                                    <td>{{ trip.arrival_time|time:"h:i A"|default:"-" }}</td>
                                    <td>
                                        {% if trip.is_active %}
                                        <span class="badge bg-success">Active</span>
                                        {% else %}
                                        <span class="badge bg-secondary">Inactive</span>
                                        {% endif %}
                                    </td>
                                </tr>
                                {% empty %}
                                <tr>
                                    <td colspan="4" class="text-center text-muted py-4">
                                        <i class="fas fa-info-circle me-2"></i>No trips scheduled.
                                        {% if user.is_admin_user %}
                                        <a href="{% url 'schedules:route_edit' route.id %}">Add trips</a>
                                        {% endif %}
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% else %}
                    <!-- Long Road Style Display -->
                    {% if route.route_type == 'long' %}
                    <div class="alert alert-warning border mb-3">
                        <strong><i class="fas fa-flag-checkered me-2"></i>Final Destination:</strong> {{ route.destination_name|default:"Not specified" }}
                        {% if route.service_days %}
                        <span class="float-end">
                            <strong>Service Days:</strong> {{ route.get_service_days_display }}
                        </span>
                        {% endif %}
                    </div>
                    <h6 class="mb-3"><i class="fas fa-map-marker-alt me-2 text-warning"></i>Pickup Points</h6>
                    <div class="list-group">
                        {% for stop in route.stops.all %}
                        <div class="list-group-item d-flex justify-content-between align-items-center">
                            <div>
                                <span class="badge bg-warning text-dark me-2">{{ stop.order }}</span>
                                <strong>{{ stop.name }}</strong>
                            </div>
                            <div>
                                {% if stop.scheduled_time %}
                                <span class="badge bg-dark fs-6">
                                    <i class="fas fa-clock me-1"></i>{{ stop.scheduled_time|time:"h:i A" }}
                                </span>
                                {% else %}
                                <span class="text-muted">No time set</span>
                                {% endif %}
                            </div>
                        </div>
                        {% empty %}
                        <div class="list-group-item text-center text-muted">
                            <i class="fas fa-info-circle me-2"></i>No pickup points configured.
                            {% if user.is_admin_user %}
                            <a href="{% url 'schedules:route_edit' route.id %}">Add pickup points</a>
                            {% endif %}
                        </div>
                        {% endfor %}
                    </div>
                    {% if route.stops.exists %}
                    <div class="mt-3 p-3 bg-light border rounded">
                        <div class="d-flex align-items-center">
                            <i class="fas fa-flag-checkered text-success me-3 fs-4"></i>
                            <div>
                                <small class="text-muted">Final Stop</small>
                                <h5 class="mb-0">{{ route.destination_name }}</h5>
                            </div>
                        </div>
                    </div>
                    {% endif %}
                    {% else %}
                    <!-- Generic trip display for other types -->
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>#</th>
                                    <th>Trip Name</th>
                                    <th>Type</th>
                                    <th>Departure</th>
                                    <th>Arrival</th>
                                    <th>Stops</th>
                                    <th>Status</th>
                                    {% if user.is_admin_user %}<th>Actions</th>{% endif %}
                                </tr>
                            </thead>
                            <tbody>
                                {% for trip in route.trips.all %}
                                <tr>
                                    <td>{{ trip.order }}</td>
                                    <td><a href="{% url 'schedules:trip_detail' trip.id %}">{{ trip.name }}</a></td>
                                    <td><span class="badge bg-{{ trip.trip_type }}">{{ trip.get_trip_type_display }}</span></td>
                                    <td>{{ trip.departure_time|time:"H:i" }}</td>
                                    <td>{{ trip.arrival_time|time:"H:i" }}</td>
                                    <td>{{ trip.stop_times.count }}</td>
                                    <td>
                                        {% if trip.is_active %}
                                        <span class="badge bg-success">Active</span>
                                        {% else %}
                                        <span class="badge bg-secondary">Inactive</span>
                                        {% endif %}
                                    </td>
                                    {% if user.is_admin_user %}
                                    <td>
                                        <a href="{% url 'schedules:trip_edit' trip.id %}" class="btn btn-sm btn-outline-warning">
                                            <i class="fas fa-edit me-1"></i> Edit
                                        </a>
                                        <a href="{% url 'schedules:trip_delete' trip.id %}" class="btn btn-sm btn-outline-danger">
                                            <i class="fas fa-trash me-1"></i> Delete
                                        </a>
                                    </td>
                                    {% endif %}
                                </tr>
                                {% empty %}
                                <tr>
                                    <td colspan="{% if user.is_admin_user %}8{% else %}7{% endif %}" class="text-center text-muted py-4">
                                        <i class="fas fa-info-circle me-2"></i>No trips configured.
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% endif %}
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <div class="row mt-4">
        <div class="col-12">
            <div class="card shadow-sm">
                <div class="card-header">
                    <i class="bi bi-calendar-week me-2"></i>Schedules
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>Day</th>
                                    <th>Departure</th>
                                    <th>Arrival</th>
                                    <th>Notes</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for schedule in schedules %}
                                <tr>
                                    <td>{{ schedule.get_day_of_week_display }}</td>
                                    <td>{{ schedule.departure_time|time:"H:i" }}</td>
                                    <td>{{ schedule.arrival_time|time:"H:i" }}</td>
                                    <td class="text-muted">{{ schedule.notes|default:"-" }}</td>
                                </tr>
                                {% empty %}
                                <tr>
                                    <td colspan="4" class="text-center text-muted">No schedules configured</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    const map = L.map('routeMap').setView([40.7128, -74.0060], 13);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

    const stops = [
        {% for stop in stops %}
        {id: {{ stop.id }}, name: "{{ stop.name }}", lat: {{ stop.latitude }}, lng: {{ stop.longitude }}, order: {{ stop.order }}},
        {% endfor %}
    ];

    if (stops.length > 0) {
        const coords = stops.map(s => [s.lat, s.lng]);
        L.polyline(coords, {color: '{{ route.color }}', weight: 4}).addTo(map);

        stops.forEach(stop => {
            L.circleMarker([stop.lat, stop.lng], {
                radius: 8,
                fillColor: '{{ route.color }}',
                color: '#fff',
                weight: 2,
                fillOpacity: 0.8
            }).addTo(map).bindPopup(`<strong>${stop.order}. ${stop.name}</strong>`);
        });

        map.fitBounds(coords);
    }

    function updateETAs() {
        fetch('/api/routes/{{ route.id }}/eta/')
            .then(r => r.json())
            .then(data => {
                data.stops.forEach(stop => {
                    const etaEl = document.getElementById(`eta-${stop.id}`);
                    const statusEl = document.getElementById(`status-${stop.id}`);
                    
                    if (etaEl && stop.eta) {
                        etaEl.textContent = stop.eta;
                        if (stop.is_delayed) {
                            etaEl.classList.add('text-danger');
                            statusEl.innerHTML = `<span class="badge bg-danger">+${stop.delay_minutes} min</span>`;
                        } else {
                            etaEl.classList.add('text-success');
                            statusEl.innerHTML = '<span class="badge bg-success">On Time</span>';
                        }
                    }
                });
            });
    }

    updateETAs();
    setInterval(updateETAs, 10000);
});
</script>
{% endblock %}
